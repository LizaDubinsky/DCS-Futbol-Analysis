---
title: "Final Project DCS 375"
author: "Dieter Villegas, Liza Dubinsky, Quinn Macauley"
date: "4/6/2022"
output: html_document
---


```{r load-libraries}
library(dplyr)
library(igraph)
library(bipartite)
```


```{r clean-data}

# read in the RDS
wc_rds <- readRDS("WC_events_clean.RDS")

# grab only the columns we're interested in for analysis
wc_maxtrix <- cbind(wc_rds$period,wc_rds$timestamp, wc_rds$duration,wc_rds$possession_team.name,wc_rds$type.name,wc_rds$player.name,wc_rds$team.name,wc_rds$pass.length,wc_rds$pass.recipient.name,wc_rds$pass.outcome.name,wc_rds$ball_receipt.outcome.name,wc_rds$match_id,wc_rds$location.x,wc_rds$location.y,wc_rds$pass.end_location.x,wc_rds$pass.end_location.y)

# turn into a dataframe
wc_df_official <- as.data.frame(wc_maxtrix)

# rename the columns for analysis
colnames(wc_df_official) <- c("period","timestamp","duration","possession_team.name","type.name","player.name","team.name","pass.length","pass.recipient.name","pass.outcome.name","ball_receipt.outcome.name","match_id","location.x","location.y","pass.end_location.x","pass.end_location.y")

# grab only the passes
network_passes <- subset(wc_df_official, type.name == "Pass")

# create 4 data sets for four games we plan to analyze
france_croatia_final <- subset(network_passes, possession_team.name == c("France", "Croatia"))

france_belgium_semi <- subset(network_passes, team.name == c("France", "Belgium"))

france_uruguay_quarter <- subset(network_passes, team.name == c("France", "Uruguay"))

france_argentina_round <- subset(network_passes, team.name == c("France", "Argentina"))

# write 4 csv files for each of these games

write.csv(france_croatia_final, "france_croatia_final.csv", row.names = FALSE)

write.csv(france_belgium_semi, "france_belgium_semi.csv", row.names = FALSE)

write.csv(france_uruguay_quarter, "france_uruguay_quarter.csv", row.names = FALSE)

write.csv(france_argentina_round, "france_argentina_round.csv", row.names = FALSE)

```

```{r}
# clean the data frame to only include passes from france and croatia final
team_name_france_croatia_final <- subset(france_croatia_final, team.name == c("France", "Croatia"))

france_only_final <- subset(team_name_france_croatia_final, team.name == "France")

croatia_only_final <- subset(team_name_france_croatia_final, team.name == "Croatia")

# construct dataset for connected passes only 
connected_pass_france_final <- subset(france_only_final, is.na(pass.outcome.name))
connected_pass_croatia_final <- subset(croatia_only_final, is.na(pass.outcome.name))

# create an edgelist of passes to and from players
france_final <- cbind(connected_pass_france_final$player.name, connected_pass_france_final$pass.recipient.name)

croatia_final <- cbind(connected_pass_croatia_final$player.name, connected_pass_croatia_final$pass.recipient.name)

# name these columns
colnames(france_final) <- c("from", "to")
colnames(croatia_final) <- c("from", "to")
```

```{r france-final-object}


# create a graph object for network analysis
france_final.g <- graph.edgelist(france_final.a, directed = TRUE) # makes a graph object
croatia_final.g <- graph.edgelist(croatia_final, directed = TRUE) # makes a graph object

png(file="france_final.png", width=4000, height=4000)
plot(france_final.g, edge.width = E(france_final.g)$weight)
png(file="croatia_final.png", width=4000, height=4000)
plot(croatia_final.g)
dev.off()
```

```{r}
# Creates Frequency Tables by Player for the French Team in the Final
player_pass_france_f <- as.data.frame(table(france_only_final$player.name))
player_recieve_france_f <- as.data.frame(table(france_only_final$pass.recipient.name))
# Power Law Fit for the Passes by the French Team in the Final
fit_power_law(player_pass_france_f$Freq)
# Power Law Fit for the Receptions by the French Team in the Final
fit_power_law(player_recieve_france_f$Freq)
```

**Power-Law Fit for the Passes and Receptions by the French Team in the Final:** Using a frequency table for the number of passes and receptions made by the French team in the 2018 World Cup final, we were able to run a power-law fit test to see if this data does in fact match a power-law distribution. This analysis could be made separately, and each does tell its own story, but together the analyses make a better story. If we look at the alpha value for each, we see that alpha is 2.186 and 13.142 for the passes and receptions, respectively. A larger alpha implies that the data is heavily skewed, and a smaller alpha implies that the data is less skewed. So, we see that the passes made by the French team are less skewed and the receptions are very skewed. If we look at the p-values, we see that the passes have a p-value of 0.701, which implies that it has a relatively high fit for the power-law. The number of passes is more evenly distributed because anyone can steal the ball, and thus make a pass. Conversely, we see that the p-value for the receptions is 0.999, which says that all of the receptions made by do fit the power-law very well. This makes sense because when looking to advance up the field, you want to pass it to your best players so that they may score a goal. So, a few players receive the majority of the passes, whereas the rest of the players only receive the ball a few times because you want your best players to have control of the ball so that you can score goals and win the game. in the context of the game, we believe that the reason we came to these conclusions is that the defenders are stealing the ball and making passes, but they are passing to the offensive players so that they can counterattack and score. One of the most effective ways to score a goal in soccer is to quickly get control of the ball while the other team is attacking and make a lightning-quick drive for the goal because the other team is focused on their own attack. Counterattacks are effective plays and lead to a good shot for a team to score a goal. It appears that in the World Cup Final, the French team employed the counterattack strategy to its maximum effect, as shown by our power-law fit tests.

```{r}
# Creates Frequency Tables by Player for the Croatian Team in the Final
player_pass_croatia_f <- as.data.frame(table(croatia_only_final$player.name))
player_recieve_croatia_f <- as.data.frame(table(croatia_only_final$pass.recipient.name))
# Power Law Fit for the Passes by the Croatian Team in the Final
fit_power_law(player_pass_croatia_f$Freq)
# Power Law Fit for the Receptions by the Croatian Team in the Final
fit_power_law(player_recieve_croatia_f$Freq)
```

**Power Law Fit for the Passes and Receptions by the Croatian Team in the Final:** Using a frequency table for the number of passes and receptions made by the French team in the 2018 World Cup final, we were able to run a power-law fit test to see if this data does in fact match a power-law distribution. This analysis could be made separately, and each does tell its own story, but together the analyses make a better story. If we look at the alpha value for each, we see that alpha is 2.186 and 13.142 for the passes and receptions, respectively. A larger alpha implies that the data is heavily skewed, and a smaller alpha implies that the data is less skewed. So, we see that the passes made by the French team are less skewed and the receptions are very skewed. If we look at the p-values, we see that the passes have a p-value of 0.701, which implies that it has a relatively high fit for the power law. The number of passes are more evenly distributed because anyone can steal the ball, and thus make a pass. Conversely, we see that the p-value for the receptions is 0.999, which says that all of the receptions made by does fit the power law very well. This makes sense because when looking to advance up the field, you want to pass it to your best players so that they may score a goal. So, a few number of players receive the majority of the passes, whereas the rest of the players only receive the ball a few times because you want your best players to have control of the ball so that you can score goals and win the game. in the context of the game, we believe that the reason we came to these conclusions is because the defenders are stealing the ball and making passes, but they are passing to the offensive players so that they can counterattack and score. One of the most effective ways to score a goal in soccer is to quickly get control of the ball while the other team is attacking and make a lightning-quick drive for the goal because the other team is focused on their own attack. Counterattacks are effective plays, and lead to a good shot for a team to score a goal. 

